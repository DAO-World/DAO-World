module.exports=function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=12)}([function(e,r){e.exports=require("bn.js")},function(e,r){e.exports=require("@babel/runtime/regenerator")},function(e,r){e.exports=require("web3-utils")},function(e,r){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,r){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,r){e.exports=require("eccrypto")},function(e,r){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,r){e.exports=require("@babel/runtime/helpers/classCallCheck")},function(e,r){e.exports=require("@babel/runtime/helpers/createClass")},function(e,r){e.exports=require("elliptic")},function(e,r){e.exports=require("loglevel")},function(e,r){e.exports=require("json-stable-stringify")},function(e,r,t){"use strict";t.r(r);var n=t(1),o=t.n(n),u=t(3),i=t.n(u),a=t(4),c=t.n(a),s=t(7),f=t.n(s),l=t(8),p=t.n(l),h=t(0),d=t.n(h),g=t(5),b=t(9),v=t(2);function m(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function y(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?m(Object(t),!0).forEach((function(r){i()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):m(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var k=function(e,r){var t=new Promise((function(r,t){var n=setTimeout((function(){clearTimeout(n),t(new Error("Timed out in ".concat(e,"ms")))}),e)}));return Promise.race([r,t])},O=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(r)},o=y(y(y({},n),t),{method:"POST"});return k(12e3,fetch(e,o).then((function(e){if(e.ok)return e.json();throw e})))},x=function(e,r){return{jsonrpc:"2.0",method:e,id:10,params:r}},w=t(10),P=t.n(w).a.getLogger("torus.js"),j=function(e,r){return new Promise((function(t,n){var o,u=0,i={resolved:!1},a=new Array(e.length).fill(void 0),c=new Array(e.length).fill(void 0);e.forEach((function(s,f){s.then((function(e){c[f]=e})).catch((function(e){a[f]=e})).finally((function(){i.resolved||r(c.slice(0),i).then((function(e){i.resolved=!0,t(e)})).catch((function(e){o=e})).finally((function(r){(u+=1)===e.length&&n(new Error("Unable to resolve enough promises, errors: ".concat(JSON.stringify(a),", responses: ").concat(JSON.stringify(c),", predicate: ").concat(o.message||o)))}))}))}))}))},S=t(6),_=t.n(S),E=t(11),q=t.n(E);function D(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function M(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?D(Object(t),!0).forEach((function(r){i()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):D(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var A=function e(r,t){var n=r;if("number"==typeof n&&(n=Array.from({length:n},(function(e,r){return r}))),t>n.length||t<=0)return[];if(t===n.length)return[n];if(1===t)return n.reduce((function(e,r){return[].concat(_()(e),[[r]])}),[]);for(var o=[],u=[],i=0;i<=n.length-t+1;i+=1){u=e(n.slice(i+1),t-1);for(var a=0;a<u.length;a+=1)o.push([n[i]].concat(_()(u[a])))}return o},X=function(e,r){for(var t={},n=0;n<e.length;n+=1){var o=q()(e[n]);if(t[o]=t[o]?t[o]+1:1,t[o]===r)return e[n]}},Y=function(e,r,t){var n=e.map((function(e){return O(e,x("VerifierLookupRequest",{verifier:r,verifier_id:t.toString()})).catch((function(e){}))}));return j(n,(function(r){var t=r.filter((function(e){return e})),n=X(t.map((function(e){return e&&e.error})),1+~~(e.length/2)),o=X(t.map((function(e){return e&&e.result})),1+~~(e.length/2));return o||n?Promise.resolve({keyResult:o,errorResult:n}):Promise.reject(new Error("invalid"))})).catch((function(e){}))},B=function e(r,t,n,o,u,i){var a,c;if(void 0===n?(a=Math.floor(Math.random()*r.length),c=a):a=n%r.length,a===o)throw new Error("Looped through all");void 0!==o&&(c=o);var s=x("KeyAssign",{verifier:u,verifier_id:i.toString()});return O("https://signer.tor.us/api/sign",s,{headers:{pubKeyX:t[a].X,pubKeyY:t[a].Y}}).then((function(n){return O(r[a],M(M({},s),n),{headers:{"Content-Type":"application/json; charset=utf-8"}}).catch((function(n){return e(r,t,a+1,c,u,i)}))}))};function K(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function C(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?K(Object(t),!0).forEach((function(r){i()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):K(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var F=function(){function e(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=r.enableLogging,n=void 0!==t&&t,o=r.metadataHost,u=void 0===o?"https://metadata.tor.us":o;f()(this,e),this.ec=new b.ec("secp256k1"),this.metadataHost=u,P.setDefaultLevel("DEBUG"),n||P.disableAll()}var r,t,n;return p()(e,[{key:"retrieveShares",value:(n=c()(o.a.mark((function e(r,t,n,u,i){var a,s,f,l,p,h,b,m,y=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(a=[],s=Object(g.generatePrivate)(),f=Object(g.getPublic)(s).toString("hex"),l=f.slice(2,66),p=f.slice(66),h=Object(v.keccak256)(i),b=0;b<r.length;b+=1)m=O(r[b],x("CommitmentRequest",{messageprefix:"mug00",tokencommitment:h.slice(2),temppubx:l,temppuby:p,timestamp:(Date.now()-2e3).toString().slice(0,10),verifieridentifier:n})).catch((function(e){return P.debug("commitment",e)})),a.push(m);return e.abrupt("return",j(a,(function(e){return e.filter((function(e){return e})).length>=3*~~(r.length/4)+1?Promise.resolve(e):Promise.reject(new Error("invalid"))})).then((function(e){for(var a=[],f=[],l=0;l<e.length;l+=1)e[l]&&f.push(e[l].result);for(var p=0;p<r.length;p+=1){var h=O(r[p],x("ShareRequest",{encrypted:"yes",item:[C(C({},u),{},{idtoken:i,nodesignatures:f,verifieridentifier:n})]})).catch((function(e){return P.debug("share req",e)}));a.push(h)}return j(a,function(){var e=c()(o.a.mark((function e(n,u){var i,a,c,f,l,p,h,b,v,m,k,O,x,w;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n.filter((function(e){return e})),a=X(n.map((function(e){return e&&e.result&&e.result.keys[0].PublicKey})),1+~~(r.length/2)),!(i.length>=1+~~(r.length/2)&&a)){e.next=32;break}for(c=[],f=[],l=0;l<n.length;l+=1)n[l]&&n[l].result&&n[l].result.keys&&n[l].result.keys.length>0?(n[l].result.keys.sort((function(e,r){return new d.a(e.Index,16).cmp(new d.a(r.Index,16))})),n[l].result.keys[0].Metadata?(p={ephemPublicKey:Buffer.from(n[l].result.keys[0].Metadata.ephemPublicKey,"hex"),iv:Buffer.from(n[l].result.keys[0].Metadata.iv,"hex"),mac:Buffer.from(n[l].result.keys[0].Metadata.mac,"hex"),mode:Buffer.from(n[l].result.keys[0].Metadata.mode,"hex")},c.push(Object(g.decrypt)(s,C(C({},p),{},{ciphertext:Buffer.from(atob(n[l].result.keys[0].Share).padStart(64,"0"),"hex")})).catch((function(e){return P.debug("share decryption",e)})))):c.push(Promise.resolve(Buffer.from(n[l].result.keys[0].Share.padStart(64,"0"),"hex")))):c.push(Promise.resolve(void 0)),f.push(new d.a(t[l],16));return e.next=8,Promise.all(c);case 8:if(h=e.sent,!u.resolved){e.next=11;break}return e.abrupt("return",void 0);case 11:b=h.reduce((function(e,r,t){return r&&e.push({index:f[t],value:new d.a(r)}),e}),[]),v=A(b.length,1+~~(r.length/2)),k=function(e){var r=v[e],t=b.filter((function(e,t){return r.includes(t)})),n=t.map((function(e){return e.value})),o=t.map((function(e){return e.index})),u=y.lagrangeInterpolation(n,o),i=Object(g.getPublic)(Buffer.from(u.toString(16,64),"hex")).toString("hex"),c=i.slice(2,66),s=i.slice(66);if(0===new d.a(c,16).cmp(new d.a(a.X,16))&&0===new d.a(s,16).cmp(new d.a(a.Y,16)))return m=u,"break"},O=0;case 15:if(!(O<v.length)){e.next=22;break}if("break"!==k(O)){e.next=19;break}return e.abrupt("break",22);case 19:O+=1,e.next=15;break;case 22:if(void 0!==m){e.next=24;break}throw new Error("could not derive private key");case 24:return e.next=26,y.getMetadata({pub_key_X:a.X,pub_key_Y:a.Y});case 26:if(x=e.sent,!u.resolved){e.next=29;break}return e.abrupt("return",void 0);case 29:return m=m.add(x).umod(y.ec.curve.n),w=y.generateAddressFromPrivKey(m),e.abrupt("return",{ethAddress:w,privKey:m.toString("hex",64)});case 32:throw new Error("invalid");case 33:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}())})));case 8:case"end":return e.stop()}}),e)}))),function(e,r,t,o,u){return n.apply(this,arguments)})},{key:"getMetadata",value:(t=c()(o.a.mark((function e(r,t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,O("".concat(this.metadataHost,"/get"),r,t);case 3:if((n=e.sent)&&n.message){e.next=6;break}return e.abrupt("return",new d.a(0));case 6:return e.abrupt("return",new d.a(n.message,16));case 9:return e.prev=9,e.t0=e.catch(0),P.error(e.t0),e.abrupt("return",new d.a(0));case 13:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e,r){return t.apply(this,arguments)})},{key:"generateMetadataParams",value:function(e,r){var t=this.ec.keyFromPrivate(r.toString("hex",64)),n={data:e,timestamp:new d.a(Date.now()).toString(16)},o=t.sign(Object(v.keccak256)(JSON.stringify(n)).slice(2));return{pub_key_X:t.getPublic().getX().toString("hex"),pub_key_Y:t.getPublic().getY().toString("hex"),set_data:n,signature:Buffer.from(o.r.toString(16,64)+o.s.toString(16,64)+new d.a(o.v).toString(16,2),"hex").toString("base64")}}},{key:"setMetadata",value:(r=c()(o.a.mark((function e(r,t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,O("".concat(this.metadataHost,"/set"),r,t);case 3:return n=e.sent,e.abrupt("return",n.message);case 7:return e.prev=7,e.t0=e.catch(0),P.error(e.t0),e.abrupt("return","");case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(e,t){return r.apply(this,arguments)})},{key:"lagrangeInterpolation",value:function(e,r){if(e.length!==r.length)return null;for(var t=new d.a(0),n=0;n<e.length;n+=1){for(var o=new d.a(1),u=new d.a(1),i=0;i<e.length;i+=1)if(n!==i){o=(o=o.mul(r[i].neg())).umod(this.ec.curve.n);var a=r[n].sub(r[i]);a=a.umod(this.ec.curve.n),u=u.mul(a).umod(this.ec.curve.n)}var c=o.mul(u.invm(this.ec.curve.n)).umod(this.ec.curve.n);c=c.mul(e[n]).umod(this.ec.curve.n),t=t.add(c)}return t.umod(this.ec.curve.n)}},{key:"generateAddressFromPrivKey",value:function(e){var r=this.ec.keyFromPrivate(e.toString("hex",64),"hex").getPublic().encode("hex").slice(2),t="0x".concat(Object(v.keccak256)(Buffer.from(r,"hex")).slice(26));return Object(v.toChecksumAddress)(t)}},{key:"generateAddressFromPubKey",value:function(e,r){var t=this.ec.keyFromPublic({x:e.toString("hex",64),y:r.toString("hex",64)}).getPublic().encode("hex").slice(2),n="0x".concat(Object(v.keccak256)(Buffer.from(t,"hex")).slice(26));return Object(v.toChecksumAddress)(n)}},{key:"getPublicAddress",value:function(e,r,t){var n=this,u=t.verifier,i=t.verifierId,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return Y(e,u,i).then((function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.keyResult,o=t.errorResult;if(o)return B(e,r,void 0,void 0,u,i).then((function(r){return Y(e,u,i)}));if(n)return{keyResult:n};throw new Error("node results do not match")})).then(c()(o.a.mark((function e(){var r,t,u,i,c,s,f,l,p=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=p.length>0&&void 0!==p[0]?p[0]:{},!(t=r.keyResult)){e.next=13;break}return u=t.keys[0],i=u.pub_key_X,c=u.pub_key_Y,e.next=5,n.getMetadata({pub_key_X:i,pub_key_Y:c});case 5:if(s=e.sent,f=n.ec.keyFromPublic({x:i.toString(16),y:c.toString(16)}).getPublic().add(n.ec.keyFromPrivate(s.toString(16)).getPublic()),i=f.getX().toString(16),c=f.getY().toString(16),l=n.generateAddressFromPubKey(f.getX(),f.getY()),a){e.next=12;break}return e.abrupt("return",l);case 12:return e.abrupt("return",{address:l,X:i,Y:c});case 13:throw new Error("node results do not match");case 14:case"end":return e.stop()}}),e)}))))}}]),e}();r.default=F}]).default;